require(["esri/Map","esri/views/MapView","esri/widgets/Locate","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/Graphic","esri/renderers/SimpleRenderer","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/renderers/UniqueValueRenderer","esri/geometry/Extent","esri/widgets/Popup","bootstrap/Dropdown","bootstrap/Collapse","calcite-maps/calcitemaps-v0.3","dojo/domReady!"],function(e,t,r,o,n,u,i,a,p,s,l,d){var m=17,c=-71.116076,g=42.37305,v=-7915458.81211143,y=-7917751.9229597915,f=5217414.497463334,h=5216847.191394078,w={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i)},any:function(){return w.Android()||w.BlackBerry()||w.iOS()||w.Opera()||w.Windows()}};w.any()&&(m=16,c=-71.116286,g=42.37175,v=-7916229.045165166,y=-7917088.961733397,f=5217530.483504136,h=5216121.17579509);var b=new o({url:"https://map.harvard.edu/arcgis/rest/services/fdo/fdo/MapServer",outFields:["*"],visible:!0,renderer:new i({symbol:new p({color:[0,137,252,.4],style:"solid",outline:{width:1,color:"blue"}})})}),x=new n,A=new t({container:"mapViewDiv",map:new e({basemap:"topo",layers:[b,x]}),center:[c,g],zoom:m,padding:{top:50,bottom:0},breakpoints:{xsmall:768,small:769,medium:992,large:1200}});A.constraints={rotationEnabled:!1};var E=new r({view:A});function B(e){x.removeAll();for(var t=e.results[0].graphic.attributes,r=t.Primary_Building_Name,o=document.getElementById("infoDorms"),n=0;n<o.options.length;n++)if(o.options[n].value===r){o.selectedIndex=n;break}var i=new u({geometry:e.results[0].graphic.geometry,symbol:new p({color:[255,0,0,.6],style:"solid",outline:{color:"red",width:2}})});x.add(i);var a=document.createElement("ul"),s=t;for(var n in s)if("Yes"==s[n]){var l=document.createElement("li");l.appendChild(document.createTextNode(n.split(/(?=[A-Z])/).join(" "))),a.appendChild(l)}var d="<div><img width='300px' src='https://map.harvard.edu/images/bldg_photos/"+t.url+"'</img><p>"+t.Notes+"</p><p>"+a.outerHTML+"</p></div>";A.popup.open({title:t.Dorm_Name,content:d})}A.ui.add(E,{position:"top-left"}),A.on("click",function(e){e.stopPropagation(),document.getElementById("alert_placeholder").style.display="none",document.getElementById("infoAmenities").options[0].selected=!0;var t=e.screenPoint;A.popup.location=e.mapPoint,A.hitTest(t).then(B)});var I=document.getElementById("infoAmenities");function M(e){A.extent=new l({xmin:y,ymin:h,xmax:v,ymax:f,spatialReference:102100}),x.removeAll();var t=e.features.map(function(e){return e.symbol=new p({color:[255,0,0,.6],style:"solid",outline:{color:"red",width:2}}),e});x.addMany(t)}I.addEventListener("change",function(){var e,t,r=I.options[I.selectedIndex].value;(e=r,t=b.createQuery(),t.where=e+" = 'Yes'",b.queryFeatures(t)).then(M),document.getElementById("infoDorms").options[0].selected=!0,A.popup.visible=!1});var P=document.getElementById("infoDorms");function D(e){x.removeAll();var t=e.features.map(function(e){return e.symbol=new p({color:[255,0,0,.6],style:"solid",outline:{color:"red",width:2}}),e}),r=document.createElement("ul"),o=e.features[0].attributes;for(var n in o)if("Yes"==o[n]){console.log(o[n],n);var i=document.createElement("li");i.appendChild(document.createTextNode(n.split(/(?=[A-Z])/).join(" "))),r.appendChild(i)}A.popup.location={latitude:e.features[0].geometry.centroid.latitude,longitude:e.features[0].geometry.centroid.longitude},A.popup.title=e.features[0].attributes.Dorm_Name;var a="<div><img width='300px' src='https://map.harvard.edu/images/bldg_photos/"+e.features[0].attributes.url+"'</img><p>"+e.features[0].attributes.Notes+"</p><p>"+r.outerHTML+"</p></div>";A.popup.content=a,console.log(A.popup.content),A.popup.visible=!0,x.addMany(t)}P.addEventListener("change",function(){console.log("Dorm change"),A.popup.clear(),A.extent=new l({xmin:y,ymin:h,xmax:v,ymax:f,spatialReference:102100});var e,t,r=P.options[P.selectedIndex].value;(e=r,t=b.createQuery(),t.where="Primary_Building_Name = '"+e+"'",b.queryFeatures(t)).then(D),document.getElementById("infoAmenities").options[0].selected=!0})});