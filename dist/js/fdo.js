require(["esri/Map","esri/views/MapView","esri/widgets/Locate","esri/layers/FeatureLayer","esri/layers/GraphicsLayer","esri/Graphic","esri/renderers/SimpleRenderer","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleFillSymbol","esri/renderers/UniqueValueRenderer","esri/geometry/Extent","esri/widgets/Popup","bootstrap/Dropdown","bootstrap/Collapse","calcite-maps/calcitemaps-v0.3","dojo/domReady!"],function(e,t,r,o,n,i,a,s,l,d,u,p){function c(e){M.removeAll();for(var t=e.results[0].graphic,r=t.attributes,o=r.Primary_Building_Name,n=document.getElementById("infoDorms"),a=0;a<n.options.length;a++)if(n.options[a].value===o){n.selectedIndex=a;break}var s=new i({geometry:e.results[0].graphic.geometry,symbol:new l({color:[255,0,0,.6],style:"solid",outline:{color:"red",width:2}})});M.add(s);var d=document.createElement("ul"),u=r;console.log(s.geometry.centroid);for(var a in u)if("Yes"==u[a]){var p=document.createElement("li");p.appendChild(document.createTextNode(a.split(/(?=[A-Z])/).join(" "))),d.appendChild(p)}var c="<div><img width='300px' src='https://map.harvard.edu/images/bldg_photos/"+r.url+"'</img><p>"+r.Notes+"</p><p>"+d.outerHTML+"</p></div>";_.popup.clear(),_.popup.location={latitude:s.geometry.centroid.latitude,longitude:s.geometry.centroid.longitude},_.popup.title=r.Dorm_Name,_.popup.content=c,_.popup.visible=!0,_.popup.open()}function m(e){var t=D.createQuery();return t.where=e+" = 'Yes'",D.queryFeatures(t)}function g(e){_.extent=new u({xmin:x,ymin:E,xmax:b,ymax:A,spatialReference:102100}),M.removeAll();var t=e.features.map(function(e){return e.symbol=new l({color:[255,0,0,.6],style:"solid",outline:{color:"red",width:2}}),e});M.addMany(t)}function y(e){var t=D.createQuery();return t.where="Primary_Building_Name = '"+e+"'",D.queryFeatures(t)}function v(e){M.removeAll();var t=e.features.map(function(e){return e.symbol=new l({color:[255,0,0,.6],style:"solid",outline:{color:"red",width:2}}),e}),r=document.createElement("ul"),o=e.features[0].attributes;for(var n in o)if("Yes"==o[n]){console.log(o[n],n);var i=document.createElement("li");i.appendChild(document.createTextNode(n.split(/(?=[A-Z])/).join(" "))),r.appendChild(i)}_.popup.location={latitude:e.features[0].geometry.centroid.latitude,longitude:e.features[0].geometry.centroid.longitude},_.popup.title=e.features[0].attributes.Dorm_Name;var a=e.features[0].attributes.url,s=e.features[0].attributes.Notes,d="<div><img width='300px' src='https://map.harvard.edu/images/bldg_photos/"+a+"'</img><p>"+s+"</p><p>"+r.outerHTML+"</p></div>";_.popup.content=d,_.popup.visible=!0,M.addMany(t)}var f=17,h=-71.116076,w=42.37305,b=-7915458.81211143,x=-7917751.9229597915,A=5217414.497463334,E=5216847.191394078,B={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)||navigator.userAgent.match(/WPDesktop/i)},any:function(){return B.Android()||B.BlackBerry()||B.iOS()||B.Opera()||B.Windows()}};B.any()&&(f=16,h=-71.116286,w=42.37175,b=-7916229.045165166,x=-7917088.961733397,A=5217530.483504136,E=5216121.17579509);var I=new a({symbol:new l({color:[0,137,252,.4],style:"solid",outline:{width:1,color:"blue"}})}),D=new o({url:"https://map.harvard.edu/arcgis/rest/services/FDO/fdo/MapServer",outFields:["*"],visible:!0,renderer:I}),M=new n,P=new e({basemap:"topo",layers:[D,M]}),_=new t({container:"mapViewDiv",map:P,center:[h,w],zoom:f,padding:{top:50,bottom:0},breakpoints:{xsmall:768,small:769,medium:992,large:1200}});_.constraints={rotationEnabled:!1};var k=new r({view:_});_.ui.add(k,{position:"top-left"}),_.on("click",function(e){e.stopPropagation(),document.getElementById("alert_placeholder").style.display="none",document.getElementById("infoAmenities").options[0].selected=!0;var t=e.screenPoint;_.hitTest(t).then(c)});var N=document.getElementById("infoAmenities");N.addEventListener("change",function(){m(N.options[N.selectedIndex].value).then(g),document.getElementById("infoDorms").options[0].selected=!0,_.popup.visible=!1});var S=document.getElementById("infoDorms");S.addEventListener("change",function(){console.log("Dorm change"),_.popup.clear(),_.extent=new u({xmin:x,ymin:E,xmax:b,ymax:A,spatialReference:102100}),y(S.options[S.selectedIndex].value).then(v),document.getElementById("infoAmenities").options[0].selected=!0})});